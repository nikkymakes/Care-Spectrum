<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareSpectrum‚Ñ¢ | AI-Powered Weekly Digest Generator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e7e5e4 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        const WORKER_URL = 'https://carespectrum-api.zenamaomo.workers.dev';

        function CareSpectrum() {
            const [isGenerating, setIsGenerating] = useState(false);
            const [progress, setProgress] = useState('');
            const [digest, setDigest] = useState(null);
            const [error, setError] = useState(null);

            const generateDigest = async () => {
                setIsGenerating(true);
                setError(null);
                setProgress('üîç Searching UK care sector news and generating digest...');
                
                try {
                    // Calculate date range (last 7 days)
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - 7);
                    
                    const formatDate = (date) => {
                        const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                                       'July', 'August', 'September', 'October', 'November', 'December'];
                        return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
                    };
                    
                    const dateRange = `${formatDate(startDate)} to ${formatDate(endDate)}`;
                    
                    // ONE comprehensive API call instead of 13!
                    const prompt = `You are CareSpectrum‚Ñ¢, an AI digest curator for the UK children and young people's care sector.

Search the web for UK children's care sector developments from ${dateRange} and create a comprehensive weekly digest.

Cover these topic areas:
- Foster care and kinship care
- SEND (Special Educational Needs) and EHCP provision
- Safeguarding and mental health
- Residential care and children's homes
- Youth justice and lived experience voices

For each topic, find 2-4 recent significant stories from UK sources.

Also search for 2-3 impactful quotes from UK foster carers, care-experienced people, or SEND advocates on social media (X/Twitter, LinkedIn) from the past week.

Format your response as valid JSON with this EXACT structure (no additional text before or after):

{
  "overview": "3-5 line overview of major themes, tensions, or emerging patterns from this week",
  "categories": {
    "foster": {
      "name": "Foster & Kinship",
      "icon": "üè†",
      "items": [
        {
          "headline": "brief summary of story",
          "source": "source name",
          "url": "article url if found",
          "perspective": "Gov or NGO or Carer or Media or Activist or Academic"
        }
      ]
    },
    "send": {
      "name": "SEND & Education",
      "icon": "üìö",
      "items": []
    },
    "safeguarding": {
      "name": "Safeguarding & Mental Health",
      "icon": "üõ°Ô∏è",
      "items": []
    },
    "residential": {
      "name": "Residential & Policy",
      "icon": "üèõÔ∏è",
      "items": []
    },
    "voices": {
      "name": "Lived Voices & Justice",
      "icon": "üó£Ô∏è",
      "items": []
    }
  },
  "sectorVoices": [
    {
      "quote": "the quote text",
      "name": "name or @handle",
      "platform": "X or LinkedIn",
      "url": "link if available"
    }
  ],
  "reflection": "2-3 line reflection on what this week reveals - patterns, blind spots, or shifts in power"
}

Return ONLY valid JSON, nothing else.`;

                    const response = await fetch(WORKER_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: prompt,
                            useWebSearch: true
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `API error: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // Extract text from response
                    const text = data.content
                        .filter(item => item.type === "text")
                        .map(item => item.text)
                        .join("\n")
                        .trim();

                    console.log('Raw response:', text); // Debug log

                    // More robust JSON extraction - handles markdown code blocks and extra text
                    let jsonText = text;
                    
                    // Remove markdown code blocks if present
                    jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '');
                    
                    // Find JSON object (even if there's text before/after)
                    const jsonMatch = jsonText.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        console.error('Could not find JSON in response:', text);
                        throw new Error('Could not find valid JSON in response. The AI may have returned text instead of structured data.');
                    }

                    let digestData;
                    try {
                        digestData = JSON.parse(jsonMatch[0]);
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError);
                        console.error('Attempted to parse:', jsonMatch[0]);
                        throw new Error('Invalid JSON format in response. Try again.');
                    }
                    
                    setProgress('‚úÖ Digest generated!');
                    setDigest(digestData);
                    
                } catch (err) {
                    setError(err.message || 'Failed to generate digest');
                    console.error('Generation error:', err);
                } finally {
                    setIsGenerating(false);
                }
            };

            const removeItem = (categoryId, itemIndex) => {
                setDigest(prev => ({
                    ...prev,
                    categories: {
                        ...prev.categories,
                        [categoryId]: {
                            ...prev.categories[categoryId],
                            items: prev.categories[categoryId].items.filter((_, i) => i !== itemIndex)
                        }
                    }
                }));
            };

            const removeVoice = (index) => {
                setDigest(prev => ({
                    ...prev,
                    sectorVoices: prev.sectorVoices.filter((_, i) => i !== index)
                }));
            };

            const exportDigest = () => {
                if (!digest) return '';

                let output = 'üìä WEEKLY OVERVIEW\n\n';
                output += digest.overview || 'No overview generated.';
                output += '\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
                output += 'üîç THIS WEEK\'S CARESPECTRUM\n\n';

                Object.values(digest.categories).forEach(category => {
                    if (category.items && category.items.length > 0) {
                        output += `**${category.name}**\n`;
                        category.items.forEach(item => {
                            output += `‚Ä¢ ${item.headline}`;
                            if (item.source) output += ` ‚Äî ${item.source}`;
                            if (item.url) output += ` (${item.url})`;
                            if (item.perspective) output += ` *(${item.perspective})*`;
                            output += '\n';
                        });
                        output += '\n';
                    }
                });

                if (digest.sectorVoices && digest.sectorVoices.length > 0) {
                    output += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
                    output += 'üó£Ô∏è VOICES FROM THE SECTOR\n\n';
                    digest.sectorVoices.forEach(voice => {
                        output += `"${voice.quote}"\n`;
                        output += `‚Äî ${voice.name} [${voice.platform}]`;
                        if (voice.url) output += ` üîó ${voice.url}`;
                        output += '\n\n';
                    });
                }

                output += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
                output += 'üí° WHY IT MATTERS\n\n';
                output += digest.reflection || 'No reflection generated.';
                output += '\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
                output += 'üì° STAY INFORMED\n\n';
                output += 'CareSpectrum widens the lens. Not just the headlines, but the margins too. Follow for full-spectrum insight each week.\n\n';
                output += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
                output += 'üìã ATTRIBUTION & LEGAL NOTICE\n\n';
                output += 'CareSpectrum‚Ñ¢ is an independent, AI-powered digest created and trademarked by Adenike Omoregbee.\n\n';
                output += '¬© 2025 Adenike Omoregbee ... Foster Carer. All rights reserved.\n';
                output += 'To connect: @adenikeomoregbee on LinkedIn\n\n';
                output += '#CareSpectrum #CreatedByAdenike #FullSpectrumCare';

                return output;
            };

            const copyToClipboard = () => {
                const text = exportDigest();
                navigator.clipboard.writeText(text);
                alert('Copied to clipboard!');
            };

            const downloadDigest = () => {
                const text = exportDigest();
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `carespectrum-${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
            };

            return (
                <div style={{minHeight: '100vh', background: 'linear-gradient(135deg, #f8fafc 0%, #e7e5e4 100%)'}}>
                    {/* Header */}
                    <div style={{background: 'white', borderBottom: '1px solid #e5e7eb', boxShadow: '0 1px 3px rgba(0,0,0,0.1)'}}>
                        <div style={{maxWidth: '1200px', margin: '0 auto', padding: '2rem'}}>
                            <div style={{height: '6px', background: 'linear-gradient(90deg, #9333ea 0%, #3b82f6 20%, #14b8a6 40%, #10b981 60%, #f59e0b 80%, #ef4444 100%)', borderRadius: '3px', marginBottom: '1.5rem'}} />
                            <h1 style={{fontSize: '3rem', fontFamily: 'Georgia, serif', fontWeight: 'bold', color: '#581c87', marginBottom: '0.5rem'}}>CareSpectrum‚Ñ¢</h1>
                            <p style={{color: '#78716c', fontSize: '0.875rem', textTransform: 'uppercase', letterSpacing: '0.1em'}}>AI-Powered Weekly Digest Generator</p>
                            <p style={{color: '#a8a29e', fontStyle: 'italic', marginTop: '0.5rem'}}>Widening the lens. Not just the headlines, but the margins too.</p>
                        </div>
                    </div>

                    <div style={{maxWidth: '1200px', margin: '0 auto', padding: '2rem'}}>
                        {/* Start Screen */}
                        {!isGenerating && !digest && (
                            <div style={{background: 'white', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', padding: '3rem', textAlign: 'center'}}>
                                <div style={{width: '80px', height: '80px', background: 'linear-gradient(135deg, #9333ea, #3b82f6)', borderRadius: '50%', margin: '0 auto 1.5rem', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '2rem'}}>
                                    ‚ú®
                                </div>
                                <h2 style={{fontSize: '2rem', fontFamily: 'Georgia, serif', fontWeight: 'bold', color: '#1c1917', marginBottom: '1rem'}}>
                                    Generate This Week's Digest
                                </h2>
                                <p style={{color: '#78716c', marginBottom: '2rem', maxWidth: '600px', margin: '0 auto 2rem'}}>
                                    Click the button below and CareSpectrum‚Ñ¢ will automatically search UK news, 
                                    scan social media, categorize stories, and generate a complete weekly digest 
                                    for the children's care sector.
                                </p>
                                <button
                                    onClick={generateDigest}
                                    style={{
                                        background: 'linear-gradient(135deg, #9333ea, #3b82f6)',
                                        color: 'white',
                                        padding: '1rem 2rem',
                                        borderRadius: '8px',
                                        fontWeight: '600',
                                        fontSize: '1.125rem',
                                        border: 'none',
                                        cursor: 'pointer',
                                        display: 'inline-flex',
                                        alignItems: 'center',
                                        gap: '0.75rem'
                                    }}
                                >
                                    üîç Generate Digest
                                </button>
                                <p style={{color: '#a8a29e', fontSize: '0.875rem', marginTop: '1.5rem'}}>
                                    Typically takes 20-30 seconds
                                </p>
                            </div>
                        )}

                        {/* Generating State */}
                        {isGenerating && (
                            <div style={{background: 'white', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', padding: '3rem', textAlign: 'center'}}>
                                <div style={{fontSize: '4rem', marginBottom: '1.5rem'}}>‚è≥</div>
                                <h2 style={{fontSize: '1.5rem', fontFamily: 'Georgia, serif', fontWeight: 'bold', color: '#1c1917', marginBottom: '1rem'}}>
                                    Generating Your Digest...
                                </h2>
                                <p style={{color: '#78716c', marginBottom: '1rem'}}>{progress}</p>
                                <div style={{width: '100%', maxWidth: '500px', background: '#e7e5e4', borderRadius: '999px', height: '8px', margin: '0 auto'}}>
                                    <div style={{background: 'linear-gradient(90deg, #9333ea, #3b82f6)', height: '8px', borderRadius: '999px', width: '70%', animation: 'pulse 2s infinite'}} />
                                </div>
                            </div>
                        )}

                        {/* Error State */}
                        {error && (
                            <div style={{background: '#fef2f2', border: '1px solid #fecaca', borderRadius: '12px', padding: '1.5rem', textAlign: 'center'}}>
                                <p style={{color: '#991b1b', fontWeight: '600', marginBottom: '0.5rem'}}>Error generating digest</p>
                                <p style={{color: '#dc2626', fontSize: '0.875rem', marginBottom: '0.5rem'}}>{error}</p>
                                <p style={{color: '#78716c', fontSize: '0.75rem', fontStyle: 'italic'}}>If you see a 429 error, you may have hit rate limits. Wait a minute and try again.</p>
                                <button
                                    onClick={() => { setError(null); setDigest(null); }}
                                    style={{marginTop: '1rem', background: '#dc2626', color: 'white', padding: '0.5rem 1rem', borderRadius: '6px', border: 'none', cursor: 'pointer'}}
                                >
                                    Try Again
                                </button>
                            </div>
                        )}

                        {/* Results */}
                        {digest && !isGenerating && (
                            <div style={{display: 'flex', flexDirection: 'column', gap: '1.5rem'}}>
                                {/* Action Bar */}
                                <div style={{background: 'white', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', padding: '1.5rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '1rem'}}>
                                    <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem', color: '#10b981'}}>
                                        <span style={{fontSize: '1.25rem'}}>‚úÖ</span>
                                        <span style={{fontWeight: '600'}}>Digest Generated! Review and edit below.</span>
                                    </div>
                                    <div style={{display: 'flex', gap: '0.75rem'}}>
                                        <button onClick={copyToClipboard} style={{background: '#f59e0b', color: 'white', padding: '0.5rem 1rem', borderRadius: '8px', border: 'none', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                                            üìã Copy
                                        </button>
                                        <button onClick={downloadDigest} style={{background: '#3b82f6', color: 'white', padding: '0.5rem 1rem', borderRadius: '8px', border: 'none', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                                            üíæ Download
                                        </button>
                                        <button onClick={() => setDigest(null)} style={{background: '#e7e5e4', color: '#1c1917', padding: '0.5rem 1rem', borderRadius: '8px', border: 'none', cursor: 'pointer'}}>
                                            New Digest
                                        </button>
                                    </div>
                                </div>

                                {/* Overview */}
                                <div style={{background: 'white', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', padding: '1.5rem'}}>
                                    <h3 style={{fontSize: '1.25rem', fontFamily: 'Georgia, serif', fontWeight: 'bold', color: '#581c87', marginBottom: '1rem'}}>
                                        üìä Weekly Overview
                                    </h3>
                                    <p style={{color: '#44403c', lineHeight: '1.7'}}>{digest.overview}</p>
                                </div>

                                {/* Categories */}
                                {Object.entries(digest.categories).map(([id, category]) => (
                                    category.items && category.items.length > 0 && (
                                        <div key={id} style={{background: 'white', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', padding: '1.5rem'}}>
                                            <h3 style={{fontSize: '1.25rem', fontFamily: 'Georgia, serif', fontWeight: 'bold', color: '#1e40af', marginBottom: '1rem'}}>
                                                {category.icon} {category.name}
                                            </h3>
                                            <div style={{display: 'flex', flexDirection: 'column', gap: '0.75rem'}}>
                                                {category.items.map((item, idx) => (
                                                    <div key={idx} style={{borderLeft: '4px solid #14b8a6', paddingLeft: '1rem', paddingRight: '1rem', paddingTop: '0.5rem', paddingBottom: '0.5rem', background: '#fafaf9', borderRadius: '0 8px 8px 0', position: 'relative'}}>
                                                        <button
                                                            onClick={() => removeItem(id, idx)}
                                                            style={{position: 'absolute', right: '0.5rem', top: '0.5rem', background: 'none', border: 'none', color: '#dc2626', cursor: 'pointer', fontSize: '1.25rem'}}
                                                        >
                                                            √ó
                                                        </button>
                                                        <p style={{color: '#1c1917', fontWeight: '500', marginBottom: '0.25rem'}}>{item.headline}</p>
                                                        <p style={{color: '#78716c', fontSize: '0.875rem'}}>
                                                            {item.source && <span style={{fontWeight: '600'}}>{item.source}</span>}
                                                            {item.perspective && <span style={{fontStyle: 'italic', marginLeft: '0.5rem'}}>({item.perspective})</span>}
                                                        </p>
                                                        {item.url && (
                                                            <a href={item.url} target="_blank" rel="noopener noreferrer" style={{color: '#3b82f6', fontSize: '0.875rem', textDecoration: 'none'}}>
                                                                Read more ‚Üí
                                                            </a>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )
                                ))}

                                {/* Voices */}
                                {digest.sectorVoices && digest.sectorVoices.length > 0 && (
                                    <div style={{background: 'white', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', padding: '1.5rem'}}>
                                        <h3 style={{fontSize: '1.25rem', fontFamily: 'Georgia, serif', fontWeight: 'bold', color: '#047857', marginBottom: '1rem'}}>
                                            üó£Ô∏è Voices from the Sector
                                        </h3>
                                        <div style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                                            {digest.sectorVoices.map((voice, idx) => (
                                                <div key={idx} style={{border: '1px solid #e7e5e4', padding: '1rem', borderRadius: '8px', background: '#fafaf9', position: 'relative'}}>
                                                    <button
                                                        onClick={() => removeVoice(idx)}
                                                        style={{position: 'absolute', right: '0.5rem', top: '0.5rem', background: 'none', border: 'none', color: '#dc2626', cursor: 'pointer', fontSize: '1.25rem'}}
                                                    >
                                                        √ó
                                                    </button>
                                                    <p style={{color: '#44403c', fontStyle: 'italic', marginBottom: '0.5rem'}}>"{voice.quote}"</p>
                                                    <p style={{color: '#78716c', fontSize: '0.875rem'}}>
                                                        ‚Äî {voice.name} <span style={{color: '#a8a29e'}}>[{voice.platform}]</span>
                                                        {voice.url && (
                                                            <a href={voice.url} target="_blank" rel="noopener noreferrer" style={{marginLeft: '0.5rem', color: '#3b82f6', textDecoration: 'none'}}>
                                                                üîó
                                                            </a>
                                                        )}
                                                    </p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Reflection */}
                                <div style={{background: 'white', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', padding: '1.5rem'}}>
                                    <h3 style={{fontSize: '1.25rem', fontFamily: 'Georgia, serif', fontWeight: 'bold', color: '#be123c', marginBottom: '1rem'}}>
                                        üí° Why It Matters
                                    </h3>
                                    <p style={{color: '#44403c', lineHeight: '1.7'}}>{digest.reflection}</p>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Footer */}
                    <div style={{maxWidth: '1200px', margin: '0 auto', padding: '2rem', textAlign: 'center', color: '#78716c', fontSize: '0.875rem', borderTop: '1px solid #e7e5e4', marginTop: '3rem'}}>
                        <p><strong style={{color: '#581c87'}}>CareSpectrum‚Ñ¢</strong> is an independent, AI-powered digest created and trademarked by <strong style={{color: '#581c87'}}>Adenike Omoregbee</strong>.</p>
                        <p style={{marginTop: '0.5rem'}}>¬© 2025 Adenike Omoregbee ... Foster Carer. All rights reserved.</p>
                        <p style={{marginTop: '0.5rem'}}>Connect: <a href="https://linkedin.com/in/adenikeomoregbee" target="_blank" rel="noopener noreferrer" style={{color: '#3b82f6', textDecoration: 'none'}}>@adenikeomoregbee on LinkedIn</a></p>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<CareSpectrum />, document.getElementById('root'));
    </script>
</body>
</html>
