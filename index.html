import React, { useState } from 'react';
import { Search, Sparkles, Download, Copy, Loader2, X, Edit2, CheckCircle } from 'lucide-react';

export default function CareSpectrum() {
  const [isGenerating, setIsGenerating] = useState(false);
  const [progress, setProgress] = useState('');
  const [digest, setDigest] = useState(null);
  const [error, setError] = useState(null);

  const categories = [
    { id: 'foster', name: 'Foster & Kinship', icon: 'üè†', searchTerms: ['foster care uk', 'kinship care uk', 'fostering news uk'] },
    { id: 'send', name: 'SEND & Education', icon: 'üìö', searchTerms: ['SEND uk', 'EHCP uk', 'special educational needs uk'] },
    { id: 'safeguarding', name: 'Safeguarding & Mental Health', icon: 'üõ°Ô∏è', searchTerms: ['child safeguarding uk', 'child mental health uk', 'child protection uk'] },
    { id: 'residential', name: 'Residential & Policy', icon: 'üèõÔ∏è', searchTerms: ['children\'s homes uk', 'children\'s services uk', 'ofsted children'] },
    { id: 'voices', name: 'Lived Voices & Justice', icon: 'üó£Ô∏è', searchTerms: ['care experienced uk', 'youth justice uk', 'children in care uk'] }
  ];

  const generateDigest = async () => {
    setIsGenerating(true);
    setError(null);
    setProgress('Starting digest generation...');
    
    try {
      const digestData = {
        overview: '',
        categories: {},
        voices: [],
        reflection: ''
      };

      // Generate overview
      setProgress('üìä Generating weekly overview...');
      const overviewResponse = await callClaude(
        `Search for UK children's care sector news from the past 7 days and provide a 3-5 line overview of major themes, tensions, or emerging patterns. Focus on foster care, SEND, safeguarding, residential care, and policy developments.`,
        true
      );
      digestData.overview = extractText(overviewResponse);

      // Search each category
      for (const category of categories) {
        setProgress(`${category.icon} Searching ${category.name}...`);
        
        const items = [];
        for (const term of category.searchTerms) {
          try {
            const response = await callClaude(
              `Search for recent UK news about "${term}" from the past 7 days. Find 2-3 significant stories. For each story, provide in this exact JSON format:
[
  {
    "headline": "brief summary of the story",
    "source": "source name",
    "url": "article url if available",
    "perspective": "one of: Gov, NGO, Carer, Media, Activist, Academic"
  }
]
Only return valid JSON, nothing else.`,
              true
            );
            
            const text = extractText(response);
            // Try to parse JSON from the response
            const jsonMatch = text.match(/\[[\s\S]*\]/);
            if (jsonMatch) {
              const parsed = JSON.parse(jsonMatch[0]);
              items.push(...parsed.slice(0, 2)); // Limit to 2 per search
            }
          } catch (err) {
            console.error(`Error searching ${term}:`, err);
          }
          
          // Brief delay to avoid rate limits
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        digestData.categories[category.id] = {
          name: category.name,
          icon: category.icon,
          items: items.slice(0, 5) // Max 5 items per category
        };
      }

      // Get voices from the sector
      setProgress('üí¨ Finding voices from the sector...');
      const voicesResponse = await callClaude(
        `Search for recent quotes or statements from UK foster carers, care-experienced people, or SEND advocates on social media (X/Twitter, LinkedIn) from the past week. Find 3 impactful quotes. Format as JSON:
[
  {
    "quote": "the quote text",
    "name": "name or @handle",
    "platform": "X or LinkedIn or Facebook",
    "url": "link to post if available"
  }
]
Only return valid JSON, nothing else.`,
        true
      );
      
      try {
        const voicesText = extractText(voicesResponse);
        const jsonMatch = voicesText.match(/\[[\s\S]*\]/);
        if (jsonMatch) {
          digestData.voices = JSON.parse(jsonMatch[0]).slice(0, 3);
        }
      } catch (err) {
        console.error('Error parsing voices:', err);
        digestData.voices = [];
      }

      // Generate reflection
      setProgress('üí° Generating reflection...');
      const reflectionResponse = await callClaude(
        `Based on this week's UK children's care sector developments (foster care, SEND, safeguarding, policy), write a brief 2-3 line reflection on what the week reveals - patterns, blind spots, or shifts in power. Be insightful but concise.`,
        true
      );
      digestData.reflection = extractText(reflectionResponse);

      setProgress('‚úÖ Digest generated!');
      setDigest(digestData);
      
    } catch (err) {
      setError(err.message || 'Failed to generate digest');
      console.error('Generation error:', err);
    } finally {
      setIsGenerating(false);
    }
  };

  const callClaude = async (prompt, useWebSearch = false) => {
    const body = {
      model: "claude-sonnet-4-20250514",
      max_tokens: 1000,
      messages: [{ role: "user", content: prompt }]
    };

    if (useWebSearch) {
      body.tools = [{ type: "web_search_20250305", name: "web_search" }];
    }

    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (!response.ok) {
      throw new Error(`API error: ${response.status}`);
    }

    return await response.json();
  };

  const extractText = (response) => {
    return response.content
      .filter(item => item.type === "text")
      .map(item => item.text)
      .join("\n")
      .trim();
  };

  const removeItem = (categoryId, itemIndex) => {
    setDigest(prev => ({
      ...prev,
      categories: {
        ...prev.categories,
        [categoryId]: {
          ...prev.categories[categoryId],
          items: prev.categories[categoryId].items.filter((_, i) => i !== itemIndex)
        }
      }
    }));
  };

  const removeVoice = (index) => {
    setDigest(prev => ({
      ...prev,
      voices: prev.voices.filter((_, i) => i !== index)
    }));
  };

  const exportDigest = () => {
    if (!digest) return '';

    let output = 'üìä WEEKLY OVERVIEW\n\n';
    output += digest.overview || 'No overview generated.';
    output += '\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
    output += 'üîç THIS WEEK\'S CARESPECTRUM\n\n';

    // Categories
    Object.values(digest.categories).forEach(category => {
      if (category.items.length > 0) {
        output += `**${category.name}**\n`;
        category.items.forEach(item => {
          output += `‚Ä¢ ${item.headline}`;
          if (item.source) output += ` ‚Äî ${item.source}`;
          if (item.url) output += ` (${item.url})`;
          if (item.perspective) output += ` *(${item.perspective})*`;
          output += '\n';
        });
        output += '\n';
      }
    });

    // Voices
    if (digest.voices.length > 0) {
      output += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
      output += 'üó£Ô∏è VOICES FROM THE SECTOR\n\n';
      digest.voices.forEach(voice => {
        output += `"${voice.quote}"\n`;
        output += `‚Äî ${voice.name} [${voice.platform}]`;
        if (voice.url) output += ` üîó ${voice.url}`;
        output += '\n\n';
      });
    }

    // Reflection
    output += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
    output += 'üí° WHY IT MATTERS\n\n';
    output += digest.reflection || 'No reflection generated.';
    output += '\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
    
    // Closing
    output += 'üì° STAY INFORMED\n\n';
    output += 'CareSpectrum widens the lens. Not just the headlines, but the margins too. Follow for full-spectrum insight each week.\n\n';
    output += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
    
    // Attribution
    output += 'üìã ATTRIBUTION & LEGAL NOTICE\n\n';
    output += 'CareSpectrum‚Ñ¢ is an independent, AI-powered digest created and trademarked by Adenike Omoregbee. It exists to widen the lens on UK children and young people\'s care ‚Äî surfacing all sides of the story, from policy to lived reality.\n\n';
    output += 'Designed to be clear, balanced, and rooted in both professional and carer insight, CareSpectrum gathers from media, government, and social platforms ‚Äî including the voices often left out.\n\n';
    output += '¬© 2025 Adenike Omoregbee ... Foster Carer. All rights reserved.\n';
    output += 'To connect, collaborate, or contribute: @adenikeomoregbee on LinkedIn\n\n';
    output += '#CareSpectrum #CreatedByAdenike #FullSpectrumCare';

    return output;
  };

  const copyToClipboard = () => {
    const text = exportDigest();
    navigator.clipboard.writeText(text);
    alert('Copied to clipboard!');
  };

  const downloadDigest = () => {
    const text = exportDigest();
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `carespectrum-${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-stone-100">
      {/* Header */}
      <div className="bg-white border-b border-stone-200 shadow-sm">
        <div className="max-w-6xl mx-auto px-6 py-8">
          <div className="h-1.5 bg-gradient-to-r from-purple-600 via-blue-500 via-teal-500 via-emerald-500 via-amber-500 to-rose-500 rounded-full mb-6" />
          <h1 className="text-5xl font-serif font-bold text-purple-900 mb-2">CareSpectrum‚Ñ¢</h1>
          <p className="text-stone-600 text-lg tracking-wide uppercase text-sm">AI-Powered Weekly Digest Generator</p>
          <p className="text-stone-500 italic mt-2">Widening the lens. Not just the headlines, but the margins too.</p>
        </div>
      </div>

      <div className="max-w-6xl mx-auto px-6 py-8">
        {/* Start Screen */}
        {!isGenerating && !digest && (
          <div className="bg-white rounded-xl shadow-lg p-12 text-center">
            <div className="w-20 h-20 bg-gradient-to-br from-purple-500 to-blue-500 rounded-full mx-auto mb-6 flex items-center justify-center">
              <Sparkles className="w-10 h-10 text-white" />
            </div>
            <h2 className="text-3xl font-serif font-bold text-stone-800 mb-4">
              Generate This Week's Digest
            </h2>
            <p className="text-stone-600 mb-8 max-w-2xl mx-auto">
              Click the button below and CareSpectrum‚Ñ¢ will automatically search UK news, 
              scan social media, categorize stories, and generate a complete weekly digest 
              for the children's care sector.
            </p>
            <button
              onClick={generateDigest}
              className="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-8 py-4 rounded-lg font-semibold text-lg hover:shadow-xl transition-all transform hover:scale-105 flex items-center gap-3 mx-auto"
            >
              <Search className="w-5 h-5" />
              Generate Digest
            </button>
            <p className="text-stone-400 text-sm mt-6">
              Typically takes 30-60 seconds
            </p>
          </div>
        )}

        {/* Generating State */}
        {isGenerating && (
          <div className="bg-white rounded-xl shadow-lg p-12 text-center">
            <Loader2 className="w-16 h-16 text-purple-600 animate-spin mx-auto mb-6" />
            <h2 className="text-2xl font-serif font-bold text-stone-800 mb-4">
              Generating Your Digest...
            </h2>
            <p className="text-stone-600 mb-4">{progress}</p>
            <div className="w-full bg-stone-200 rounded-full h-2 max-w-md mx-auto">
              <div className="bg-gradient-to-r from-purple-600 to-blue-600 h-2 rounded-full animate-pulse" style={{width: '70%'}} />
            </div>
          </div>
        )}

        {/* Error State */}
        {error && (
          <div className="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
            <p className="text-red-800 font-semibold mb-2">Error generating digest</p>
            <p className="text-red-600 text-sm">{error}</p>
            <button
              onClick={() => { setError(null); setDigest(null); }}
              className="mt-4 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
            >
              Try Again
            </button>
          </div>
        )}

        {/* Results */}
        {digest && !isGenerating && (
          <div className="space-y-6">
            {/* Action Buttons */}
            <div className="bg-white rounded-xl shadow-lg p-6 flex gap-4 justify-between items-center">
              <div className="flex items-center gap-2 text-emerald-600">
                <CheckCircle className="w-5 h-5" />
                <span className="font-semibold">Digest Generated! Review and edit below.</span>
              </div>
              <div className="flex gap-3">
                <button
                  onClick={copyToClipboard}
                  className="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 flex items-center gap-2"
                >
                  <Copy className="w-4 h-4" />
                  Copy
                </button>
                <button
                  onClick={downloadDigest}
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2"
                >
                  <Download className="w-4 h-4" />
                  Download
                </button>
                <button
                  onClick={() => setDigest(null)}
                  className="bg-stone-200 text-stone-700 px-4 py-2 rounded-lg hover:bg-stone-300"
                >
                  New Digest
                </button>
              </div>
            </div>

            {/* Overview */}
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="text-xl font-serif font-bold text-purple-900 mb-4 flex items-center gap-2">
                üìä Weekly Overview
              </h3>
              <p className="text-stone-700 leading-relaxed">{digest.overview}</p>
            </div>

            {/* Categories */}
            {Object.entries(digest.categories).map(([id, category]) => (
              category.items.length > 0 && (
                <div key={id} className="bg-white rounded-xl shadow-lg p-6">
                  <h3 className="text-xl font-serif font-bold text-blue-900 mb-4 flex items-center gap-2">
                    <span>{category.icon}</span>
                    {category.name}
                  </h3>
                  <div className="space-y-3">
                    {category.items.map((item, idx) => (
                      <div key={idx} className="border-l-4 border-teal-500 pl-4 pr-4 py-2 bg-stone-50 rounded-r group hover:bg-stone-100 transition-colors relative">
                        <button
                          onClick={() => removeItem(id, idx)}
                          className="absolute right-2 top-2 opacity-0 group-hover:opacity-100 text-red-500 hover:text-red-700"
                        >
                          <X className="w-4 h-4" />
                        </button>
                        <p className="text-stone-800 font-medium">{item.headline}</p>
                        <p className="text-stone-600 text-sm mt-1">
                          {item.source && <span className="font-semibold">{item.source}</span>}
                          {item.perspective && <span className="italic ml-2">({item.perspective})</span>}
                        </p>
                        {item.url && (
                          <a href={item.url} target="_blank" rel="noopener noreferrer" className="text-blue-600 text-sm hover:underline">
                            Read more ‚Üí
                          </a>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )
            ))}

            {/* Voices */}
            {digest.voices.length > 0 && (
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h3 className="text-xl font-serif font-bold text-emerald-900 mb-4 flex items-center gap-2">
                  üó£Ô∏è Voices from the Sector
                </h3>
                <div className="space-y-4">
                  {digest.voices.map((voice, idx) => (
                    <div key={idx} className="border border-stone-200 p-4 rounded-lg bg-stone-50 group hover:bg-stone-100 transition-colors relative">
                      <button
                        onClick={() => removeVoice(idx)}
                        className="absolute right-2 top-2 opacity-0 group-hover:opacity-100 text-red-500 hover:text-red-700"
                      >
                        <X className="w-4 h-4" />
                      </button>
                      <p className="text-stone-700 italic mb-2">"{voice.quote}"</p>
                      <p className="text-stone-600 text-sm">
                        ‚Äî {voice.name} <span className="text-stone-400">[{voice.platform}]</span>
                        {voice.url && (
                          <a href={voice.url} target="_blank" rel="noopener noreferrer" className="ml-2 text-blue-600 hover:underline">
                            üîó
                          </a>
                        )}
                      </p>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Reflection */}
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="text-xl font-serif font-bold text-rose-900 mb-4 flex items-center gap-2">
                üí° Why It Matters
              </h3>
              <p className="text-stone-700 leading-relaxed">{digest.reflection}</p>
            </div>
          </div>
        )}
      </div>

      {/* Footer */}
      <div className="max-w-6xl mx-auto px-6 py-8 text-center text-stone-500 text-sm border-t border-stone-200 mt-12">
        <p><strong className="text-purple-900">CareSpectrum‚Ñ¢</strong> is an independent, AI-powered digest created and trademarked by <strong className="text-purple-900">Adenike Omoregbee</strong>.</p>
        <p className="mt-2">¬© 2025 Adenike Omoregbee ... Foster Carer. All rights reserved.</p>
        <p className="mt-2">Connect: <a href="https://linkedin.com/in/adenikeomoregbee" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">@adenikeomoregbee on LinkedIn</a></p>
      </div>
    </div>
  );
}
