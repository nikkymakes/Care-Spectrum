<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareSpectrum‚Ñ¢ | AI-Powered Weekly Digest Generator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e7e5e4 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        // IMPORTANT: Replace this with your actual Cloudflare Worker URL after deployment
        const WORKER_URL = 'https://carespectrum-api.zenamaomo.workers.dev';

        function CareSpectrum() {
            const [isGenerating, setIsGenerating] = useState(false);
            const [progress, setProgress] = useState('');
            const [digest, setDigest] = useState(null);
            const [error, setError] = useState(null);

            const categories = [
                { id: 'foster', name: 'Foster & Kinship', icon: 'üè†', searchTerms: ['foster care uk news', 'kinship care uk'] },
                { id: 'send', name: 'SEND & Education', icon: 'üìö', searchTerms: ['SEND uk news', 'EHCP uk'] },
                { id: 'safeguarding', name: 'Safeguarding & Mental Health', icon: 'üõ°Ô∏è', searchTerms: ['child safeguarding uk', 'child mental health uk'] },
                { id: 'residential', name: 'Residential & Policy', icon: 'üèõÔ∏è', searchTerms: ['children homes uk', 'ofsted children'] },
                { id: 'voices', name: 'Lived Voices & Justice', icon: 'üó£Ô∏è', searchTerms: ['care experienced uk', 'youth justice uk'] }
            ];

            const generateDigest = async () => {
                setIsGenerating(true);
                setError(null);
                setProgress('Starting digest generation...');
                
                try {
                    const digestData = {
                        overview: '',
                        categories: {},
                        voices: [],
                        reflection: ''
                    };

                    // Generate overview
                    setProgress('üìä Generating weekly overview...');
                    const overviewResponse = await callWorker(
                        `Search for UK children's care sector news from the past 7 days and provide a 3-5 line overview of major themes, tensions, or emerging patterns. Focus on foster care, SEND, safeguarding, residential care, and policy developments.`,
                        true
                    );
                    digestData.overview = extractText(overviewResponse);

                    // Search each category
                    for (const category of categories) {
                        setProgress(`${category.icon} Searching ${category.name}...`);
                        
                        const items = [];
                        for (const term of category.searchTerms.slice(0, 2)) {
                            try {
                                const response = await callWorker(
                                    `Search for recent UK news about "${term}" from the past 7 days. Find 2-3 significant stories. For each story, provide in this exact JSON format:
[
  {
    "headline": "brief summary of the story",
    "source": "source name",
    "url": "article url if available",
    "perspective": "one of: Gov, NGO, Carer, Media, Activist, Academic"
  }
]
Only return valid JSON, nothing else.`,
                                    true
                                );
                                
                                const text = extractText(response);
                                const jsonMatch = text.match(/\[[\s\S]*\]/);
                                if (jsonMatch) {
                                    try {
                                        const parsed = JSON.parse(jsonMatch[0]);
                                        items.push(...parsed.slice(0, 2));
                                    } catch (e) {
                                        console.log('Parse error:', e);
                                    }
                                }
                            } catch (err) {
                                console.error(`Error searching ${term}:`, err);
                            }
                            
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                        
                        digestData.categories[category.id] = {
                            name: category.name,
                            icon: category.icon,
                            items: items.slice(0, 5)
                        };
                    }

                    // Get voices
                    setProgress('üí¨ Finding voices from the sector...');
                    const voicesResponse = await callWorker(
                        `Search for recent quotes from UK foster carers, care-experienced people, or SEND advocates on social media from the past week. Find 3 impactful quotes. Format as JSON:
[
  {
    "quote": "the quote text",
    "name": "name or @handle",
    "platform": "X or LinkedIn",
    "url": "link if available"
  }
]
Only return valid JSON.`,
                        true
                    );
                    
                    try {
                        const voicesText = extractText(voicesResponse);
                        const jsonMatch = voicesText.match(/\[[\s\S]*\]/);
                        if (jsonMatch) {
                            digestData.voices = JSON.parse(jsonMatch[0]).slice(0, 3);
                        }
                    } catch (err) {
                        digestData.voices = [];
                    }

                    // Generate reflection
                    setProgress('üí° Generating reflection...');
                    const reflectionResponse = await callWorker(
                        `Based on this week's UK children's care sector developments, write a brief 2-3 line reflection on what the week reveals - patterns, blind spots, or shifts in power.`,
                        true
                    );
                    digestData.reflection = extractText(reflectionResponse);

                    setProgress('‚úÖ Digest generated!');
                    setDigest(digestData);
                    
                } catch (err) {
                    setError(err.message || 'Failed to generate digest');
                    console.error('Generation error:', err);
                } finally {
                    setIsGenerating(false);
                }
            };

            const callWorker = async (prompt, useWebSearch = false) => {
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        useWebSearch: useWebSearch
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Worker error: ${response.status}`);
                }

                return await response.json();
            };

            const extractText = (response) => {
                return response.content
                    .filter(item => item.type === "text")
                    .map(item => item.text)
                    .join("\n")
                    .trim();
            };

            const removeItem = (categoryId, itemIndex) => {
                setDigest(prev => ({
                    ...prev,
                    categories: {
                        ...prev.categories,
                        [categoryId]: {
                            ...prev.categories[categoryId],
                            items: prev.categories[categoryId].items.filter((_, i) => i !== itemIndex)
                        }
                    }
                }));
            };

            const removeVoice = (index) => {
                setDigest(prev => ({
                    ...prev,
                    voices: prev.voices.filter((_, i) => i !== index)
                }));
            };

            const exportDigest = () => {
                if (!digest) return '';

                let output = 'üìä WEEKLY OVERVIEW\n\n';
                output += digest.overview || 'No overview generated.';
                output += '\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
                output += 'üîç THIS WEEK\'S CARESPECTRUM\n\n';

                Object.values(digest.categories).forEach(category => {
                    if (category.items.length > 0) {
                        output += `**${category.name}**\n`;
                        category.items.forEach(item => {
                            output += `‚Ä¢ ${item.headline}`;
                            if (item.source) output += ` ‚Äî ${item.source}`;
                            if (item.url) output += ` (${item.url})`;
                            if (item.perspective) output += ` *(${item.perspective})*`;
                            output += '\n';
                        });
                        output += '\n';
                    }
                });

                if (digest.voices.length > 0) {
                    output += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
                    output += 'üó£Ô∏è VOICES FROM THE SECTOR\n\n';
                    digest.voices.forEach(voice => {
                        output += `"${voice.quote}"\n`;
                        output += `‚Äî ${voice.name} [${voice.platform}]`;
                        if (voice.url) output += ` üîó ${voice.url}`;
                        output += '\n\n';
                    });
                }

                output += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
                output += 'üí° WHY IT MATTERS\n\n';
                output += digest.reflection || 'No reflection generated.';
                output += '\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
                output += 'üì° STAY INFORMED\n\n';
                output += 'CareSpectrum widens the lens. Not just the headlines, but the margins too. Follow for full-spectrum insight each week.\n\n';
                output += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
                output += 'üìã ATTRIBUTION & LEGAL NOTICE\n\n';
                output += 'CareSpectrum‚Ñ¢ is an independent, AI-powered digest created and trademarked by Adenike Omoregbee.\n\n';
                output += '¬© 2025 Adenike Omoregbee ... Foster Carer. All rights reserved.\n';
                output += 'To connect: @adenikeomoregbee on LinkedIn\n\n';
                output += '#CareSpectrum #CreatedByAdenike #FullSpectrumCare';

                return output;
            };

            const copyToClipboard = () => {
                const text = exportDigest();
                navigator.clipboard.writeText(text);
                alert('Copied to clipboard!');
            };

            const downloadDigest = () => {
                const text = exportDigest();
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `carespectrum-${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
            };

            return (
                <div style={{minHeight: '100vh', background: 'linear-gradient(135deg, #f8fafc 0%, #e7e5e4 100%)'}}>
                    {/* Header */}
                    <div style={{background: 'white', borderBottom: '1px solid #e5e7eb', boxShadow: '0 1px 3px rgba(0,0,0,0.1)'}}>
                        <div style={{maxWidth: '1200px', margin: '0 auto', padding: '2rem'}}>
                            <div style={{height: '6px', background: 'linear-gradient(90deg, #9333ea 0%, #3b82f6 20%, #14b8a6 40%, #10b981 60%, #f59e0b 80%, #ef4444 100%)', borderRadius: '3px', marginBottom: '1.5rem'}} />
                            <h1 style={{fontSize: '3rem', fontFamily: 'Georgia, serif', fontWeight: 'bold', color: '#581c87', marginBottom: '0.5rem'}}>CareSpectrum‚Ñ¢</h1>
                            <p style={{color: '#78716c', fontSize: '0.875rem', textTransform: 'uppercase', letterSpacing: '0.1em'}}>AI-Powered Weekly Digest Generator</p>
                            <p style={{color: '#a8a29e', fontStyle: 'italic', marginTop: '0.5rem'}}>Widening the lens. Not just the headlines, but the margins too.</p>
                        </div>
                    </div>

                    <div style={{maxWidth: '1200px', margin: '0 auto', padding: '2rem'}}>
                        {/* Start Screen */}
                        {!isGenerating && !digest && (
                            <div style={{background: 'white', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', padding: '3rem', textAlign: 'center'}}>
                                <div style={{width: '80px', height: '80px', background: 'linear-gradient(135deg, #9333ea, #3b82f6)', borderRadius: '50%', margin: '0 auto 1.5rem', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '2rem'}}>
                                    ‚ú®
                                </div>
                                <h2 style={{fontSize: '2rem', fontFamily: 'Georgia, serif', fontWeight: 'bold', color: '#1c1917', marginBottom: '1rem'}}>
                                    Generate This Week's Digest
                                </h2>
                                <p style={{color: '#78716c', marginBottom: '2rem', maxWidth: '600px', margin: '0 auto 2rem'}}>
                                    Click the button below and CareSpectrum‚Ñ¢ will automatically search UK news, 
                                    scan social media, categorize stories, and generate a complete weekly digest 
                                    for the children's care sector.
                                </p>
                                <button
                                    onClick={generateDigest}
                                    style={{
                                        background: 'linear-gradient(135deg, #9333ea, #3b82f6)',
                                        color: 'white',
                                        padding: '1rem 2rem',
                                        borderRadius: '8px',
                                        fontWeight: '600',
                                        fontSize: '1.125rem',
                                        border: 'none',
                                        cursor: 'pointer',
                                        display: 'inline-flex',
                                        alignItems: 'center',
                                        gap: '0.75rem'
                                    }}
                                >
                                    üîç Generate Digest
                                </button>
                                <p style={{color: '#a8a29e', fontSize: '0.875rem', marginTop: '1.5rem'}}>
                                    Typically takes 30-60 seconds
                                </p>
                            </div>
                        )}

                        {/* Generating State */}
                        {isGenerating && (
                            <div style={{background: 'white', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', padding: '3rem', textAlign: 'center'}}>
                                <div style={{fontSize: '4rem', marginBottom: '1.5rem'}}>‚è≥</div>
                                <h2 style={{fontSize: '1.5rem', fontFamily: 'Georgia, serif', fontWeight: 'bold', color: '#1c1917', marginBottom: '1rem'}}>
                                    Generating Your Digest...
                                </h2>
                                <p style={{color: '#78716c', marginBottom: '1rem'}}>{progress}</p>
                                <div style={{width: '100%', maxWidth: '500px', background: '#e7e5e4', borderRadius: '999px', height: '8px', margin: '0 auto'}}>
                                    <div style={{background: 'linear-gradient(90deg, #9333ea, #3b82f6)', height: '8px', borderRadius: '999px', width: '70%', animation: 'pulse 2s infinite'}} />
                                </div>
                            </div>
                        )}

                        {/* Error State */}
                        {error && (
                            <div style={{background: '#fef2f2', border: '1px solid #fecaca', borderRadius: '12px', padding: '1.5rem', textAlign: 'center'}}>
                                <p style={{color: '#991b1b', fontWeight: '600', marginBottom: '0.5rem'}}>Error generating digest</p>
                                <p style={{color: '#dc2626', fontSize: '0.875rem'}}>{error}</p>
                                <button
                                    onClick={() => { setError(null); setDigest(null); }}
                                    style={{marginTop: '1rem', background: '#dc2626', color: 'white', padding: '0.5rem 1rem', borderRadius: '6px', border: 'none', cursor: 'pointer'}}
                                >
                                    Try Again
                                </button>
                            </div>
                        )}

                        {/* Results */}
                        {digest && !isGenerating && (
                            <div style={{display: 'flex', flexDirection: 'column', gap: '1.5rem'}}>
                                {/* Action Bar */}
                                <div style={{background: 'white', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', padding: '1.5rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '1rem'}}>
                                    <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem', color: '#10b981'}}>
                                        <span style={{fontSize: '1.25rem'}}>‚úÖ</span>
                                        <span style={{fontWeight: '600'}}>Digest Generated! Review and edit below.</span>
                                    </div>
                                    <div style={{display: 'flex', gap: '0.75rem'}}>
                                        <button onClick={copyToClipboard} style={{background: '#f59e0b', color: 'white', padding: '0.5rem 1rem', borderRadius: '8px', border: 'none', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                                            üìã Copy
                                        </button>
                                        <button onClick={downloadDigest} style={{background: '#3b82f6', color: 'white', padding: '0.5rem 1rem', borderRadius: '8px', border: 'none', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                                            üíæ Download
                                        </button>
                                        <button onClick={() => setDigest(null)} style={{background: '#e7e5e4', color: '#1c1917', padding: '0.5rem 1rem', borderRadius: '8px', border: 'none', cursor: 'pointer'}}>
                                            New Digest
                                        </button>
                                    </div>
                                </div>

                                {/* Overview */}
                                <div style={{background: 'white', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', padding: '1.5rem'}}>
                                    <h3 style={{fontSize: '1.25rem', fontFamily: 'Georgia, serif', fontWeight: 'bold', color: '#581c87', marginBottom: '1rem'}}>
                                        üìä Weekly Overview
                                    </h3>
                                    <p style={{color: '#44403c', lineHeight: '1.7'}}>{digest.overview}</p>
                                </div>

                                {/* Categories */}
                                {Object.entries(digest.categories).map(([id, category]) => (
                                    category.items.length > 0 && (
                                        <div key={id} style={{background: 'white', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', padding: '1.5rem'}}>
                                            <h3 style={{fontSize: '1.25rem', fontFamily: 'Georgia, serif', fontWeight: 'bold', color: '#1e40af', marginBottom: '1rem'}}>
                                                {category.icon} {category.name}
                                            </h3>
                                            <div style={{display: 'flex', flexDirection: 'column', gap: '0.75rem'}}>
                                                {category.items.map((item, idx) => (
                                                    <div key={idx} style={{borderLeft: '4px solid #14b8a6', paddingLeft: '1rem', paddingRight: '1rem', paddingTop: '0.5rem', paddingBottom: '0.5rem', background: '#fafaf9', borderRadius: '0 8px 8px 0', position: 'relative'}}>
                                                        <button
                                                            onClick={() => removeItem(id, idx)}
                                                            style={{position: 'absolute', right: '0.5rem', top: '0.5rem', background: 'none', border: 'none', color: '#dc2626', cursor: 'pointer', fontSize: '1.25rem'}}
                                                        >
                                                            √ó
                                                        </button>
                                                        <p style={{color: '#1c1917', fontWeight: '500', marginBottom: '0.25rem'}}>{item.headline}</p>
                                                        <p style={{color: '#78716c', fontSize: '0.875rem'}}>
                                                            {item.source && <span style={{fontWeight: '600'}}>{item.source}</span>}
                                                            {item.perspective && <span style={{fontStyle: 'italic', marginLeft: '0.5rem'}}>({item.perspective})</span>}
                                                        </p>
                                                        {item.url && (
                                                            <a href={item.url} target="_blank" rel="noopener noreferrer" style={{color: '#3b82f6', fontSize: '0.875rem', textDecoration: 'none'}}>
                                                                Read more ‚Üí
                                                            </a>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )
                                ))}

                                {/* Voices */}
                                {digest.voices.length > 0 && (
                                    <div style={{background: 'white', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', padding: '1.5rem'}}>
                                        <h3 style={{fontSize: '1.25rem', fontFamily: 'Georgia, serif', fontWeight: 'bold', color: '#047857', marginBottom: '1rem'}}>
                                            üó£Ô∏è Voices from the Sector
                                        </h3>
                                        <div style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                                            {digest.voices.map((voice, idx) => (
                                                <div key={idx} style={{border: '1px solid #e7e5e4', padding: '1rem', borderRadius: '8px', background: '#fafaf9', position: 'relative'}}>
                                                    <button
                                                        onClick={() => removeVoice(idx)}
                                                        style={{position: 'absolute', right: '0.5rem', top: '0.5rem', background: 'none', border: 'none', color: '#dc2626', cursor: 'pointer', fontSize: '1.25rem'}}
                                                    >
                                                        √ó
                                                    </button>
                                                    <p style={{color: '#44403c', fontStyle: 'italic', marginBottom: '0.5rem'}}>"{voice.quote}"</p>
                                                    <p style={{color: '#78716c', fontSize: '0.875rem'}}>
                                                        ‚Äî {voice.name} <span style={{color: '#a8a29e'}}>[{voice.platform}]</span>
                                                        {voice.url && (
                                                            <a href={voice.url} target="_blank" rel="noopener noreferrer" style={{marginLeft: '0.5rem', color: '#3b82f6', textDecoration: 'none'}}>
                                                                üîó
                                                            </a>
                                                        )}
                                                    </p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Reflection */}
                                <div style={{background: 'white', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', padding: '1.5rem'}}>
                                    <h3 style={{fontSize: '1.25rem', fontFamily: 'Georgia, serif', fontWeight: 'bold', color: '#be123c', marginBottom: '1rem'}}>
                                        üí° Why It Matters
                                    </h3>
                                    <p style={{color: '#44403c', lineHeight: '1.7'}}>{digest.reflection}</p>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Footer */}
                    <div style={{maxWidth: '1200px', margin: '0 auto', padding: '2rem', textAlign: 'center', color: '#78716c', fontSize: '0.875rem', borderTop: '1px solid #e7e5e4', marginTop: '3rem'}}>
                        <p><strong style={{color: '#581c87'}}>CareSpectrum‚Ñ¢</strong> is an independent, AI-powered digest created and trademarked by <strong style={{color: '#581c87'}}>Adenike Omoregbee</strong>.</p>
                        <p style={{marginTop: '0.5rem'}}>¬© 2025 Adenike Omoregbee ... Foster Carer. All rights reserved.</p>
                        <p style={{marginTop: '0.5rem'}}>Connect: <a href="https://linkedin.com/in/adenikeomoregbee" target="_blank" rel="noopener noreferrer" style={{color: '#3b82f6', textDecoration: 'none'}}>@adenikeomoregbee on LinkedIn</a></p>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<CareSpectrum />, document.getElementById('root'));
    </script>
</body>
</html>
